<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tashkent Air Quality</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8fafc;
            min-height: 100vh;
            color: #1e293b;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Hero Section - The Main Message */
        .hero {
            text-align: center;
            padding: 40px 20px;
            border-radius: 24px;
            margin-bottom: 24px;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: inherit;
            filter: brightness(0.9);
            z-index: 0;
        }

        .hero-content {
            position: relative;
            z-index: 1;
        }

        .location {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .aqi-number {
            font-size: 96px;
            font-weight: 700;
            line-height: 1;
            margin-bottom: 8px;
        }

        .aqi-label {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .recommendation {
            font-size: 18px;
            opacity: 0.95;
            max-width: 400px;
            margin: 0 auto;
            line-height: 1.5;
        }

        /* AQI Colors */
        .aqi-good { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
        .aqi-moderate { background: linear-gradient(135deg, #eab308 0%, #ca8a04 100%); }
        .aqi-sensitive { background: linear-gradient(135deg, #f97316 0%, #ea580c 100%); }
        .aqi-unhealthy { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
        .aqi-very-unhealthy { background: linear-gradient(135deg, #a855f7 0%, #9333ea 100%); }
        .aqi-hazardous { background: linear-gradient(135deg, #881337 0%, #701a28 100%); }

        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .stat-item {
            background: white;
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .stat-icon {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
        }

        .stat-label {
            font-size: 12px;
            color: #64748b;
            margin-top: 4px;
        }

        /* Health Tips Card */
        .health-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .health-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .health-tips {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .tip-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 12px;
        }

        .tip-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            flex-shrink: 0;
        }

        .tip-safe { background: #dcfce7; }
        .tip-caution { background: #fef3c7; }
        .tip-danger { background: #fee2e2; }

        .tip-text {
            font-size: 13px;
            color: #475569;
            line-height: 1.4;
        }

        /* Trend Section */
        .trend-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .trend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .trend-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
        }

        .trend-period {
            display: flex;
            gap: 4px;
            background: #f1f5f9;
            padding: 4px;
            border-radius: 10px;
            flex-wrap: wrap;
        }

        .period-btn {
            padding: 8px 12px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 500;
            color: #64748b;
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-btn:hover {
            color: #1e293b;
        }

        .period-btn.active {
            background: white;
            color: #1e293b;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Comparison Card */
        .comparison-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .comparison-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        .comparison-item {
            text-align: center;
            padding: 16px;
            background: #f8fafc;
            border-radius: 12px;
        }

        .comparison-label {
            font-size: 12px;
            color: #64748b;
            margin-bottom: 8px;
        }

        .comparison-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
        }

        .comparison-change {
            font-size: 12px;
            margin-top: 4px;
            font-weight: 500;
        }

        .change-better {
            color: #22c55e;
        }

        .change-worse {
            color: #ef4444;
        }

        .change-same {
            color: #64748b;
        }

        .chart-container {
            height: 200px;
            position: relative;
        }

        .trend-summary {
            display: flex;
            justify-content: center;
            gap: 24px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #f1f5f9;
        }

        .summary-item {
            text-align: center;
        }

        .summary-value {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .summary-label {
            font-size: 12px;
            color: #64748b;
            margin-top: 2px;
        }

        /* AQI Scale */
        .scale-card {
            background: white;
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .scale-title {
            font-size: 16px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 16px;
        }

        .scale-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .scale-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 12px;
            transition: all 0.2s;
        }

        .scale-item:hover {
            background: #f8fafc;
        }

        .scale-item.active {
            background: #f1f5f9;
        }

        .scale-color {
            width: 12px;
            height: 40px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .scale-color.good { background: #22c55e; }
        .scale-color.moderate { background: #eab308; }
        .scale-color.sensitive { background: #f97316; }
        .scale-color.unhealthy { background: #ef4444; }
        .scale-color.very-unhealthy { background: #a855f7; }
        .scale-color.hazardous { background: #881337; }

        .scale-info {
            flex: 1;
        }

        .scale-range {
            font-size: 14px;
            font-weight: 600;
            color: #1e293b;
        }

        .scale-label {
            font-size: 13px;
            color: #64748b;
            margin-top: 2px;
        }

        .scale-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #1e293b;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: #94a3b8;
            font-size: 13px;
        }

        .footer a {
            color: #64748b;
            text-decoration: none;
        }

        .update-time {
            margin-top: 8px;
            font-size: 12px;
        }

        /* Loading State */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 60px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 600px) {
            .container {
                padding: 12px;
            }

            .hero {
                padding: 32px 16px;
                border-radius: 20px;
            }

            .aqi-number {
                font-size: 72px;
            }

            .aqi-label {
                font-size: 22px;
            }

            .recommendation {
                font-size: 15px;
            }

            .quick-stats {
                grid-template-columns: repeat(3, 1fr);
                gap: 8px;
            }

            .stat-item {
                padding: 16px 12px;
            }

            .stat-value {
                font-size: 20px;
            }

            .health-tips {
                grid-template-columns: 1fr;
            }

            .trend-period {
                justify-content: center;
            }

            .comparison-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .comparison-item {
                padding: 12px;
            }

            .comparison-value {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Main AQI Display -->
        <div class="hero aqi-moderate" id="heroSection">
            <div class="hero-content">
                <div class="location">Tashkent, Uzbekistan</div>
                <div class="aqi-number" id="aqiNumber">--</div>
                <div class="aqi-label" id="aqiLabel">Loading...</div>
                <div class="recommendation" id="recommendation">Checking air quality...</div>
            </div>
        </div>

        <!-- Quick Stats -->
        <div class="quick-stats">
            <div class="stat-item">
                <div class="stat-icon">üå°Ô∏è</div>
                <div class="stat-value" id="temperature">--</div>
                <div class="stat-label">Temperature</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">üíß</div>
                <div class="stat-value" id="humidity">--</div>
                <div class="stat-label">Humidity</div>
            </div>
            <div class="stat-item">
                <div class="stat-icon">üí®</div>
                <div class="stat-value" id="wind">--</div>
                <div class="stat-label">Wind</div>
            </div>
        </div>

        <!-- Health Recommendations -->
        <div class="health-card">
            <div class="health-title">
                <span>üí°</span> What should you do?
            </div>
            <div class="health-tips" id="healthTips">
                <!-- Filled dynamically -->
            </div>
        </div>

        <!-- Comparison Stats -->
        <div class="comparison-card">
            <div class="comparison-title">AQI Comparison</div>
            <div class="comparison-grid">
                <div class="comparison-item">
                    <div class="comparison-label">Today</div>
                    <div class="comparison-value" id="todayAqi">--</div>
                    <div class="comparison-change" id="todayChange">vs yesterday</div>
                </div>
                <div class="comparison-item">
                    <div class="comparison-label">This Week</div>
                    <div class="comparison-value" id="weekAqi">--</div>
                    <div class="comparison-change" id="weekChange">vs last week</div>
                </div>
                <div class="comparison-item">
                    <div class="comparison-label">This Month</div>
                    <div class="comparison-value" id="monthAqi">--</div>
                    <div class="comparison-change" id="monthChange">vs last month</div>
                </div>
            </div>
        </div>

        <!-- Trend Chart -->
        <div class="trend-card">
            <div class="trend-header">
                <div class="trend-title">Air Quality Trend</div>
                <div class="trend-period">
                    <button class="period-btn active" data-hours="6">6h</button>
                    <button class="period-btn" data-hours="24">24h</button>
                    <button class="period-btn" data-hours="72">3d</button>
                    <button class="period-btn" data-period="week">Week</button>
                    <button class="period-btn" data-period="month">Month</button>
                    <button class="period-btn" data-period="year">Year</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
            <div class="trend-summary">
                <div class="summary-item">
                    <div class="summary-value" id="minAqi">--</div>
                    <div class="summary-label">Lowest</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="avgAqi">--</div>
                    <div class="summary-label">Average</div>
                </div>
                <div class="summary-item">
                    <div class="summary-value" id="maxAqi">--</div>
                    <div class="summary-label">Highest</div>
                </div>
            </div>
        </div>

        <!-- AQI Scale Reference -->
        <div class="scale-card">
            <div class="scale-title">What do the numbers mean?</div>
            <div class="scale-items" id="scaleItems">
                <div class="scale-item" data-max="50">
                    <div class="scale-color good"></div>
                    <div class="scale-info">
                        <div class="scale-range">0 - 50</div>
                        <div class="scale-label">Good - Air quality is satisfactory</div>
                    </div>
                </div>
                <div class="scale-item" data-max="100">
                    <div class="scale-color moderate"></div>
                    <div class="scale-info">
                        <div class="scale-range">51 - 100</div>
                        <div class="scale-label">Moderate - Acceptable for most people</div>
                    </div>
                </div>
                <div class="scale-item" data-max="150">
                    <div class="scale-color sensitive"></div>
                    <div class="scale-info">
                        <div class="scale-range">101 - 150</div>
                        <div class="scale-label">Unhealthy for sensitive groups</div>
                    </div>
                </div>
                <div class="scale-item" data-max="200">
                    <div class="scale-color unhealthy"></div>
                    <div class="scale-info">
                        <div class="scale-range">151 - 200</div>
                        <div class="scale-label">Unhealthy - Everyone may feel effects</div>
                    </div>
                </div>
                <div class="scale-item" data-max="300">
                    <div class="scale-color very-unhealthy"></div>
                    <div class="scale-info">
                        <div class="scale-range">201 - 300</div>
                        <div class="scale-label">Very Unhealthy - Health alert</div>
                    </div>
                </div>
                <div class="scale-item" data-max="500">
                    <div class="scale-color hazardous"></div>
                    <div class="scale-info">
                        <div class="scale-range">301 - 500</div>
                        <div class="scale-label">Hazardous - Emergency conditions</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            <div>Data from <a href="https://www.iqair.com/" target="_blank">IQAir</a></div>
            <div class="update-time" id="updateTime">Updated just now</div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        let trendChart;
        let currentMode = 'hours'; // 'hours' or 'period'
        let currentHours = 6;
        let currentPeriod = 'week';

        const aqiLevels = [
            { max: 50, label: 'Good', class: 'aqi-good', recommendation: 'Air quality is great! Perfect day for outdoor activities.', color: '#22c55e' },
            { max: 100, label: 'Moderate', class: 'aqi-moderate', recommendation: 'Air is acceptable. Unusually sensitive people should limit prolonged outdoor exertion.', color: '#eab308' },
            { max: 150, label: 'Unhealthy for Sensitive Groups', class: 'aqi-sensitive', recommendation: 'Sensitive groups should reduce outdoor activities. Others can be outside but take it easier.', color: '#f97316' },
            { max: 200, label: 'Unhealthy', class: 'aqi-unhealthy', recommendation: 'Everyone should reduce prolonged outdoor exertion. Consider wearing a mask outside.', color: '#ef4444' },
            { max: 300, label: 'Very Unhealthy', class: 'aqi-very-unhealthy', recommendation: 'Avoid outdoor activities. Keep windows closed. Use air purifier if available.', color: '#a855f7' },
            { max: 500, label: 'Hazardous', class: 'aqi-hazardous', recommendation: 'Stay indoors! Avoid all outdoor activities. Serious health risk for everyone.', color: '#881337' }
        ];

        function getAqiInfo(aqi) {
            for (const level of aqiLevels) {
                if (aqi <= level.max) return level;
            }
            return aqiLevels[aqiLevels.length - 1];
        }

        function getHealthTips(aqi) {
            if (aqi <= 50) {
                return [
                    { icon: 'üèÉ', text: 'Great for jogging and outdoor exercise', type: 'safe' },
                    { icon: 'ü™ü', text: 'Open windows for fresh air', type: 'safe' },
                    { icon: 'üë∂', text: 'Safe for children to play outside', type: 'safe' },
                    { icon: 'üå≥', text: 'Enjoy outdoor activities', type: 'safe' }
                ];
            } else if (aqi <= 100) {
                return [
                    { icon: 'üö∂', text: 'Light outdoor activities are fine', type: 'safe' },
                    { icon: '‚ö†Ô∏è', text: 'Sensitive people should take breaks', type: 'caution' },
                    { icon: 'ü™ü', text: 'Ventilation is still okay', type: 'safe' },
                    { icon: 'üëÄ', text: 'Watch for symptoms if sensitive', type: 'caution' }
                ];
            } else if (aqi <= 150) {
                return [
                    { icon: 'üò∑', text: 'Consider wearing a mask outside', type: 'caution' },
                    { icon: 'üè†', text: 'Sensitive groups should stay indoors', type: 'caution' },
                    { icon: '‚è±Ô∏è', text: 'Limit outdoor time to 1-2 hours', type: 'caution' },
                    { icon: 'ü™ü', text: 'Keep windows mostly closed', type: 'caution' }
                ];
            } else if (aqi <= 200) {
                return [
                    { icon: 'üò∑', text: 'Wear N95 mask if going outside', type: 'danger' },
                    { icon: 'üè†', text: 'Stay indoors when possible', type: 'danger' },
                    { icon: 'üö´', text: 'Avoid outdoor exercise', type: 'danger' },
                    { icon: 'üå¨Ô∏è', text: 'Use air purifier indoors', type: 'caution' }
                ];
            } else {
                return [
                    { icon: 'üö®', text: 'Avoid going outside completely', type: 'danger' },
                    { icon: 'ü™ü', text: 'Seal windows and doors', type: 'danger' },
                    { icon: 'üå¨Ô∏è', text: 'Run air purifier continuously', type: 'danger' },
                    { icon: 'üè•', text: 'Seek help if breathing issues', type: 'danger' }
                ];
            }
        }

        function updateHealthTips(aqi) {
            const tips = getHealthTips(aqi);
            const container = document.getElementById('healthTips');
            container.innerHTML = tips.map(tip => `
                <div class="tip-item">
                    <div class="tip-icon tip-${tip.type}">${tip.icon}</div>
                    <div class="tip-text">${tip.text}</div>
                </div>
            `).join('');
        }

        function updateScaleHighlight(aqi) {
            const items = document.querySelectorAll('.scale-item');
            items.forEach(item => {
                item.classList.remove('active');
                const check = item.querySelector('.scale-check');
                if (check) check.remove();
            });

            const thresholds = [50, 100, 150, 200, 300, 500];
            let activeIndex = thresholds.findIndex(t => aqi <= t);
            if (activeIndex === -1) activeIndex = thresholds.length - 1;

            const activeItem = items[activeIndex];
            if (activeItem) {
                activeItem.classList.add('active');
                const check = document.createElement('div');
                check.className = 'scale-check';
                check.innerHTML = '‚úì';
                activeItem.appendChild(check);
            }
        }

        function formatTime(date) {
            return new Date(date).toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        async function fetchCurrentData() {
            const response = await fetch('/api/aqi/current');
            const result = await response.json();
            return result.data;
        }

        async function fetchHistoricalData(hours) {
            const response = await fetch(`/api/aqi/latest?hours=${hours}`);
            const result = await response.json();
            return result.data || [];
        }

        async function fetchAggregatedData(period) {
            const granularity = period === 'year' ? 'week' : 'day';
            const response = await fetch(`/api/aqi/history?period=${period}&granularity=${granularity}`);
            const result = await response.json();
            return result.data || [];
        }

        async function fetchComparisonData() {
            const response = await fetch('/api/aqi/comparison');
            const result = await response.json();
            return result.data || {};
        }

        function getChangeText(current, previous, label) {
            if (!current || !previous) return { text: `vs ${label}`, class: 'change-same' };
            const diff = current - previous;
            // Lower AQI = better, so positive diff means worse air quality
            if (diff > 0) {
                return { text: `${diff} worse than ${label}`, class: 'change-worse' };
            } else if (diff < 0) {
                return { text: `${Math.abs(diff)} better than ${label}`, class: 'change-better' };
            }
            return { text: `Same as ${label}`, class: 'change-same' };
        }

        async function loadComparisonData() {
            try {
                const data = await fetchComparisonData();

                // Today vs Yesterday
                if (data.today) {
                    document.getElementById('todayAqi').textContent = data.today.avg_aqi || '--';
                    const todayChange = getChangeText(data.today.avg_aqi, data.yesterday?.avg_aqi, 'yesterday');
                    const todayEl = document.getElementById('todayChange');
                    todayEl.textContent = todayChange.text;
                    todayEl.className = `comparison-change ${todayChange.class}`;
                }

                // This Week vs Last Week
                if (data.this_week) {
                    document.getElementById('weekAqi').textContent = data.this_week.avg_aqi || '--';
                    const weekChange = getChangeText(data.this_week.avg_aqi, data.last_week?.avg_aqi, 'last week');
                    const weekEl = document.getElementById('weekChange');
                    weekEl.textContent = weekChange.text;
                    weekEl.className = `comparison-change ${weekChange.class}`;
                }

                // This Month vs Last Month
                if (data.this_month) {
                    document.getElementById('monthAqi').textContent = data.this_month.avg_aqi || '--';
                    const monthChange = getChangeText(data.this_month.avg_aqi, data.last_month?.avg_aqi, 'last month');
                    const monthEl = document.getElementById('monthChange');
                    monthEl.textContent = monthChange.text;
                    monthEl.className = `comparison-change ${monthChange.class}`;
                }
            } catch (error) {
                console.error('Error loading comparison data:', error);
            }
        }

        function formatDate(date, period) {
            const d = new Date(date);
            if (period === 'year') {
                return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            } else if (period === 'month' || period === 'week') {
                return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
            }
            return formatTime(date);
        }

        function createTrendChart(data, isAggregated = false, period = 'week') {
            const ctx = document.getElementById('trendChart').getContext('2d');

            if (trendChart) {
                trendChart.destroy();
            }

            let sortedData, labels, values;

            if (isAggregated) {
                sortedData = data; // Already sorted ASC from API
                labels = sortedData.map(d => formatDate(d.time_bucket, period));
                values = sortedData.map(d => parseInt(d.avg_aqi));
            } else {
                sortedData = [...data].reverse();
                labels = sortedData.map(d => formatTime(d.timestamp));
                values = sortedData.map(d => d.aqi_us);
            }

            // Calculate gradient based on values
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, 'rgba(99, 102, 241, 0.3)');
            gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

            trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        data: values,
                        borderColor: '#6366f1',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        pointRadius: 0,
                        pointHoverRadius: 6,
                        pointHoverBackgroundColor: '#6366f1',
                        pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: '#1e293b',
                            titleFont: { size: 12 },
                            bodyFont: { size: 14, weight: 'bold' },
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                title: (items) => items[0].label,
                                label: (item) => `AQI: ${item.parsed.y}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: {
                                maxTicksLimit: 6,
                                color: '#94a3b8',
                                font: { size: 11 }
                            }
                        },
                        y: {
                            display: true,
                            beginAtZero: true,
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 11 }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    }
                }
            });

            // Update summary stats
            if (values.length > 0) {
                document.getElementById('minAqi').textContent = Math.min(...values);
                document.getElementById('avgAqi').textContent = Math.round(values.reduce((a, b) => a + b, 0) / values.length);
                document.getElementById('maxAqi').textContent = Math.max(...values);
            }
        }

        async function changeTimeRange(btn, hours = null, period = null) {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (hours) {
                currentMode = 'hours';
                currentHours = hours;
                const data = await fetchHistoricalData(hours);
                createTrendChart(data, false);
            } else if (period) {
                currentMode = 'period';
                currentPeriod = period;
                const data = await fetchAggregatedData(period);
                createTrendChart(data, true, period);
            }
        }

        // Setup period button click handlers
        document.querySelectorAll('.period-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const hours = this.dataset.hours ? parseInt(this.dataset.hours) : null;
                const period = this.dataset.period || null;
                changeTimeRange(this, hours, period);
            });
        });

        async function loadDashboard() {
            try {
                // Fetch current data and chart data based on current mode
                const currentPromise = fetchCurrentData();
                const chartPromise = currentMode === 'hours'
                    ? fetchHistoricalData(currentHours)
                    : fetchAggregatedData(currentPeriod);

                const [current, chartData] = await Promise.all([currentPromise, chartPromise]);

                // Load comparison data
                loadComparisonData();

                if (current) {
                    const aqi = current.aqi_us;
                    const info = getAqiInfo(aqi);

                    // Update hero section
                    document.getElementById('aqiNumber').textContent = aqi;
                    document.getElementById('aqiLabel').textContent = info.label;
                    document.getElementById('recommendation').textContent = info.recommendation;

                    const hero = document.getElementById('heroSection');
                    hero.className = `hero ${info.class}`;

                    // Update stats
                    document.getElementById('temperature').textContent = `${Math.round(current.temperature_celsius)}¬∞C`;
                    document.getElementById('humidity').textContent = `${current.humidity}%`;
                    document.getElementById('wind').textContent = `${current.wind_speed || '--'} m/s`;

                    // Update health tips
                    updateHealthTips(aqi);

                    // Update scale highlight
                    updateScaleHighlight(aqi);
                }

                // Update chart with the fetched data
                if (chartData && chartData.length > 0) {
                    createTrendChart(chartData, currentMode === 'period', currentPeriod);
                }

                // Update time
                document.getElementById('updateTime').textContent = `Updated ${new Date().toLocaleTimeString()}`;

            } catch (error) {
                console.error('Error loading dashboard:', error);
            }
        }

        // Initial load
        loadDashboard();

        // Refresh every 2 minutes
        setInterval(loadDashboard, 120000);
    </script>
</body>
</html>
